<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NetPlay - Interactive Networking Games & Quizzes | NetLabPro</title>
<meta name="description" content="Master networking concepts through interactive games: troubleshooting scenarios, subnetting practice, command matching, protocol quizzes, and escape room challenges. Learn by playing!">
<meta name="keywords" content="networking games, subnetting quiz, network troubleshooting game, Cisco commands practice, protocol learning games">
<link rel="canonical" href="https://techdecoded.tech/Netplay.html">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="style.css?v=1.3">
<style>
:root {
    --primary: #2c3e50;
    --secondary: #3498db;
    --accent: #e74c3c;
    --light: #ecf0f1;
    --dark: #1a252f;
    --success: #2ecc71;
    --warning: #f39c12;
}

* { 
    margin:0; 
    padding:0; 
    box-sizing:border-box; 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
}

body { 
    background-color:#f5f7fa; 
    color:#333; 
    line-height:1.6;
}

.container { 
    width:90%; 
    max-width:1200px; 
    margin:0 auto; 
    padding:0 15px; 
}
/* HEADER */
header {
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    color:white;
    padding:1rem 0;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    position:sticky;
    top:0;
    z-index:1000;
}
.header-content {
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:relative;
}
.logo {
    display:flex;
    align-items:center;
    gap:10px;
}
.logo img {
    height:50px;
    width:auto;
    transition:transform 0.3s;
    display:block;
    flex-shrink:0;
}
.logo img:hover {
    transform:scale(1.1);
}
.logo h1 {
    font-size:1.8rem;
    font-weight:700;
    color:white;
    margin:0;
    line-height:1.2;
    white-space:nowrap;
}

/* Desktop Nav */
.navbar {
    display:flex;
    align-items:center;
}
.nav-links {
    display:flex;
    list-style:none;
    gap:2rem;
    margin:0;
    padding:0;
}
.nav-links li {
    margin:0;
}
.nav-links a {
    color:white;
    text-decoration:none;
    font-weight:500;
    padding:0.5rem 1rem;
    border-radius:999px;
    transition:all 0.3s ease;
    font-size:1.1rem;
    background:rgba(255,255,255,0.12);
    border:1px solid rgba(255,255,255,0.18);
    box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04);
    backdrop-filter:blur(10px) saturate(140%);
    -webkit-backdrop-filter:blur(10px) saturate(140%);
}
.nav-links a:hover,.nav-links a.active {
    background-color:rgba(255,255,255,0.28);
    border-color:rgba(255,255,255,0.35);
    transform:translateY(-1px);
}

/* Mobile Toggle Button */
.hamburger {
    display:none;
    cursor:pointer;
    font-size:1.8rem;
    color:white;
    background:none;
    border:none;
    padding:5px;
    z-index:1001;
}

.section-title { 
    text-align:center; 
    margin:2rem 0 1rem; 
    color:var(--primary); 
    position:relative; 
    font-size:2rem; 
}
.section-title:after { 
    content:''; 
    display:block; 
    width:80px; 
    height:4px; 
    background-color:var(--secondary);
    margin:10px auto; 
}

.game-card, .lab-detail { 
    background:white; 
    border-radius:8px; 
    overflow:hidden; 
    box-shadow:0 5px 15px rgba(0,0,0,0.1); 
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    max-width:600px;
    margin:2rem auto; 
    padding:1rem; 
}
.game-card:hover { 
    transform: translateY(-5px); 
    box-shadow:0 10px 25px rgba(0,0,0,0.15);
}

.game-card-header, .lab-detail-header { 
    background-color: var(--primary); 
    color:white; 
    padding:1.5rem; 
    text-align:center; 
    border-radius:8px 8px 0 0; 
    position: relative;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.game-card-header h3 {
    width: 100%;
    text-align: center;
    margin: 0;
    position: relative;
    z-index: 1;
}

/* Ensure back button doesn't overlap content on mobile */
@media(max-width: 768px) {
    .game-card-header {
        padding-left: 0 !important;
        padding-right: 0 !important;
        min-height: 70px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .game-card-header h3 {
        width: 100% !important;
        text-align: center !important;
        padding: 0 !important;
        margin: 0 !important;
        font-size: 1rem !important;
        position: relative;
        z-index: 1;
    }
    
    .game-card-header button {
        position: absolute !important;
        left: 0.5rem !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        padding: 0.4rem 0.7rem !important;
        font-size: 0.8rem !important;
        z-index: 11 !important;
        white-space: nowrap !important;
    }
    
    .game-card-body {
        padding-top: 1.5rem !important;
        margin-top: 0 !important;
        padding-left: 1rem !important;
        padding-right: 1rem !important;
    }
    
    /* Ensure questions don't overlap with header */
    .game-card {
        margin-top: 1rem !important;
    }
}
.game-card-body, .lab-content { 
    padding:1.5rem; 
}

.opt-btn { 
    display:block; 
    width:100%; 
    text-align:left; 
    margin:0.5rem 0; 
    padding:10px 15px; 
    border-radius:6px; 
    border:2px solid var(--secondary); 
    background:var(--light); 
    cursor:pointer; 
    transition:0.3s; 
}
.opt-btn:hover { 
    background: var(--secondary); 
    color:white; 
    transform: translateX(5px);
}
.opt-correct { 
    background: var(--success); 
    color:white; 
    border-color: var(--success); 
}
.opt-wrong { 
    background: var(--accent); 
    color:white; 
    border-color: var(--accent); 
}

#scorePanel { 
    position: fixed; 
    top: 100px;
    right: 20px; 
    background: rgba(44, 62, 80, 0.95);
    backdrop-filter: blur(10px);
    color: white;
    padding: 15px; 
    border-radius: 12px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    font-weight: 700;
    z-index: 1000;
    min-width: 180px;
    display: none; /* Hidden by default, shown when game starts */
}

#finalMessage { 
    text-align:center; 
    margin-top:2rem; 
    font-size:1.2rem; 
}

#timer { 
    font-weight:bold; 
    color:var(--accent); 
    margin-bottom:10px; 
    text-align:center; 
    font-size:1rem; 
}

#progressBarContainer { 
    background:#ddd; 
    border-radius:10px; 
    margin:15px 0; 
    height:15px; 
    width:100%; 
}

#progressBar { 
    height:15px; 
    width:0%; 
    background:var(--success);
    border-radius:10px; 
    transition:width 0.3s; 
}

.btn { 
    display:inline-block; 
    background-color:var(--accent); 
    color:white; 
    padding:0.8rem 1.5rem; 
    border-radius:4px; 
    text-decoration:none; 
    font-weight:600; 
    transition: all 0.3s ease; 
    border:none; 
    cursor:pointer; 
    margin-top:1rem; 
}

.btn:hover {
    background-color:#c0392b; 
    transform: translateY(-3px); 
    box-shadow:0 5px 15px rgba(0,0,0,0.1);
}

.hint { 
    background:var(--secondary); 
    color:white; 
    padding:6px 10px; 
    border-radius:6px; 
    display:inline-block; 
    margin-bottom:10px; 
    cursor:pointer; 
    font-size:0.9rem; 
}

.lab-detail-header {
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    margin-bottom:2rem; 
    padding-bottom:1rem; 
    border-bottom:1px solid #eee; 
}

.lab-detail-header h2 { 
    color: var(--primary); 
}

.lab-content { 
    display:grid; 
    grid-template-columns:1fr; 
    gap:2rem; 
}

.lab-explanation h3 {
    color: var(--primary); 
    margin-bottom:1rem; 
    margin-top:2rem; 
    padding-bottom:0.5rem; 
    border-bottom:1px solid #eee;
}

.lab-explanation p {
    margin-bottom:1.2rem; 
}

.code-block {
    position: relative;
    background-color: #1e1e1e; 
    padding: 1rem; 
    border-radius: 8px; 
    overflow-x: auto; 
    font-family: 'Fira Code', monospace;
    border-left: 5px solid var(--primary); 
    margin-bottom: 1rem; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
}

.copy-btn {
    position: absolute;
    top: 10px; 
    right: 10px; 
    background-color: var(--primary); 
    border: none; 
    color: white; 
    padding: 5px 10px; 
    border-radius: 4px; 
    cursor: pointer; 
    font-size: 0.8rem; 
    transition: background 0.3s;
}

.copy-btn:hover { 
    background-color: rgba(52, 152, 219, 0.8); 
}

.code-explanation { 
    background-color: #f9f9f9;
    padding: 0.8rem 1rem; 
    border-left: 4px solid var(--primary); 
    border-radius: 5px; 
    margin-bottom: 1.5rem; 
    font-size: 0.9rem;
}
    

/* MEDIA QUERIES */
@media (max-width: 768px) {
    .hamburger {
        display:block;
        z-index:1001;
    }
    .navbar {
        position:static;
    }
    .nav-links {
        position:fixed;
        top:0;
        right:-100%;
        width:280px;
        height:100vh;
        background:linear-gradient(160deg, rgba(26, 37, 47, 0.9), rgba(44, 62, 80, 0.9));
        flex-direction:column;
        padding:80px 30px 30px;
        transition:right 0.3s ease-in-out;
        box-shadow:-5px 0 15px rgba(0,0,0,0.1);
        z-index:999;
        backdrop-filter:blur(16px) saturate(140%);
        -webkit-backdrop-filter:blur(16px) saturate(140%);
        border-left:1px solid rgba(255,255,255,0.12);
    }
    .nav-links.active {
        right:0;
    }
    .nav-links li {
        margin-bottom:20px;
        text-align:left;
    }
    .nav-links li:last-child {
        margin-bottom:0;
    }
    .nav-links a {
        color:white;
        display:block;
        padding:12px 15px;
        border-radius:6px;
        font-size:1.1rem;
        text-align:left;
        border:none;
    }
    .nav-links a:hover,.nav-links a.active {
        background-color:var(--secondary);
        color:white;
    }
    .logo img {
        height:40px;
        width:auto;
        flex-shrink:0;
    }
    .logo h1 {
        font-size:1.4rem;
        line-height:1.2;
        white-space:nowrap;
    }
    nav a {
        display: block;
        padding: 15px 20px;
        border-radius: 8px;
        width: 100%;
        transition: all 0.3s ease;
    }
    nav a:hover, nav a.active {
        background-color: var(--secondary);
        transform: translateX(5px);
    }
    .header-content {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
    }
    .logo {
        justify-content: space-between;
        width: 100%;
    }
}
.mode-card {
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.game-tab {
    background: rgba(255, 255, 255, 0.92);
    border: 1px solid rgba(52, 152, 219, 0.35);
    border-radius: 24px;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.35), var(--shadow-sm);
    backdrop-filter: blur(10px) saturate(140%);
    -webkit-backdrop-filter: blur(10px) saturate(140%);
}

.game-tab--escape {
    background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
    color: white;
    border-color: rgba(255, 255, 255, 0.2);
}

.mode-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-md);
    border-color: var(--secondary) !important;
}

#scorePanel {
    background: rgba(44, 62, 80, 0.95);
    backdrop-filter: blur(10px);
    color: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    min-width: 180px;
}

#scorePanel div {
    font-size: 0.9rem;
}

#xpBar {
    background: linear-gradient(90deg, var(--success) 0%, #27ae60 100%);
    box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
}

.mode-card:active {
    transform: translateY(-4px) scale(1.01);
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes floatUp {
    from {
        transform: translateY(0);
        opacity: 1;
    }
    to {
        transform: translateY(-30px);
        opacity: 0;
    }
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}

@keyframes popInOut {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
    40% { transform: translate(-50%, -50%) scale(1); }
    80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
}

@keyframes fadeOut {
    to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.9; }
}

@media(max-width: 768px) {
    /* Game cards and lab details full width */


    /* Game cards and lab details full width */
    .game-card, .lab-detail {
        width: 100%;
        margin: 1rem auto;
        padding: 1rem;
    }

    /* Option buttons smaller */
    .opt-btn {
        font-size: 0.9rem;
        padding: 8px 12px;
    }

    /* Buttons */
    .btn {
        padding: 0.7rem 1.2rem;
        font-size: 0.9rem;
    }

    /* Score panel fixed at bottom on mobile to avoid floating over content */
    #scorePanel {
        position: fixed !important;
        bottom: 10px !important;
        right: 10px !important;
        top: auto !important;
        left: auto !important;
        font-size: 0.75rem !important;
        padding: 8px 10px !important;
        max-width: 130px !important;
        min-width: 120px !important;
        z-index: 998 !important;
        transform: none !important;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3) !important;
    }
    
    /* Make score panel smaller text on very small screens */
    #scorePanel div {
        font-size: 0.7rem !important;
    }
    
    #scorePanel strong {
        font-size: 0.7rem !important;
    }
    
    #achievementToast {
        right: 10px;
        top: 10px;
        padding: 0.8rem 1rem;
        font-size: 0.9rem;
    }

    /* Timer and progress bar adjustments */
    #progressBarContainer {
        height: 12px;
    }

    #progressBar {
        height: 12px;
    }
}

/* VERY SMALL SCREENS */
@media(max-width: 480px) {
    .logo h1 {
        font-size: 1.3rem;
    }

    .opt-btn {
        font-size: 0.8rem;
    }

    .btn {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
    }
}

</style>
</head>
<body>
<header>
    <div class="container">
        <div class="header-content">
            <div class="logo">
                <img src="images/logo2.png" alt="CN Lab Helper Logo">
                <h1>NetLabPro</h1>
            </div>
            <nav class="navbar">
                <button class="hamburger" id="hamburger" onclick="toggleMobileNav()">
                    <i class="fas fa-bars"></i>
                </button>
                <ul class="nav-links" id="navLinks">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="Netplay.html" class="active">NetPlay</a></li>
                    <li><a href="about.html">About</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>
<section class="container">
<h2 class="section-title"><i class="fas fa-gamepad"></i> NetPlay - Learning Games</h2>

<!-- Game Mode Selection -->
<div id="gameModeSelection" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="mode-card game-tab" onclick="selectGameMode('troubleshooting')" style="border: 2px solid transparent;">
        <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--accent);"><i class="fas fa-tools"></i></div>
        <h3 style="color: var(--primary); margin-bottom: 0.5rem;">Troubleshooting Hero</h3>
        <p style="color: #666;">Solve network problems under time pressure</p>
    </div>
    <div class="mode-card game-tab" onclick="selectGameMode('subnetting')" style="border: 2px solid transparent;">
        <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--secondary);"><i class="fas fa-calculator"></i></div>
        <h3 style="color: var(--primary); margin-bottom: 0.5rem;">Subnetting Challenge</h3>
        <p style="color: #666;">Master subnetting calculations</p>
    </div>
    <div class="mode-card game-tab" onclick="selectGameMode('commands')" style="border: 2px solid transparent;">
        <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--success);"><i class="fas fa-terminal"></i></div>
        <h3 style="color: var(--primary); margin-bottom: 0.5rem;">Command Master</h3>
        <p style="color: #666;">Match commands with their functions</p>
    </div>
    <div class="mode-card game-tab" onclick="selectGameMode('protocols')" style="border: 2px solid transparent;">
        <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--warning);"><i class="fas fa-network-wired"></i></div>
        <h3 style="color: var(--primary); margin-bottom: 0.5rem;">Protocol Quiz</h3>
        <p style="color: #666;">Test your protocol knowledge</p>
    </div>
    <div class="mode-card game-tab game-tab--escape" onclick="selectGameMode('escape')" style="border: 2px solid transparent;">
        <div style="font-size: 3rem; margin-bottom: 1rem;"><i class="fas fa-tree"></i></div>
        <h3 style="margin-bottom: 0.5rem;">üå≤ Escape the Network Forest</h3>
        <p style="opacity: 0.9;">Solve networking puzzles to escape!</p>
    </div>
</div>

<div id="gameArea" class="game-card" style="display: none;">
    <div class="game-card-header" style="position: relative;">
        <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h3 id="gameTitle" style="margin: 0; text-align: center; width: 100%;">Welcome Hero!</h3>
    </div>
    <div class="game-card-body">
        <p id="gameDescription">You are the network administrator. Solve network issues before time runs out!</p>
        <button class="btn" onclick="startGame()" id="startBtn">Start Mission</button>
    </div>
</div>

<div id="finalMessage"></div>
<div id="timer"></div>
<div id="progressBarContainer" style="display: none;">
    <div id="progressBar"></div>
</div>
</section>

<!-- Footer -->
<footer>
    <div class="container">
        <div class="footer-content">
            <div class="footer-section">
                <h3>About NetLabPro</h3>
                <p>An interactive platform to help students visualize and understand Computer Networks laboratory experiments through detailed explanations, screenshots, and animations.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <p><a href="index.html">Home</a></p>
                <p><a href="Netplay.html">NetPlay</a></p>
                <p><a href="about.html">About</a></p>
            </div>
            <div class="footer-section">
                <h3>Connect With Us</h3>
                <div class="social-links">
                    <a href="https://linkedin.com/in/kinza-afzal7-" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>
                    <a href="https://github.com/kinza7124" target="_blank" title="GitHub"><i class="fab fa-github"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-links">
            <a href="privacy-policy.html">Privacy Policy</a> | 
            <a href="about.html">About</a> | 
            <a href="contact.html">Contact</a> | 
            <a href="terms.html">Terms & Conditions</a>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 NetLabPro created by Kinza. All rights reserved.</p>
        </div>
    </div>
</footer>

<div id="scorePanel">
    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <div><strong>Score:</strong> <span id="score">0</span></div>
        <div><strong>Level:</strong> <span id="level">1</span></div>
        <div><strong>XP:</strong> <span id="xp">0</span>/<span id="xpNeeded">100</span></div>
        <div style="width: 100px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; overflow: hidden; margin-top: 0.3rem;">
            <div id="xpBar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.3s;"></div>
        </div>
    </div>
</div>

<div id="achievementToast" style="display: none; position: fixed; top: 20px; right: 20px; background: var(--gradient-1); color: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: var(--shadow-lg); z-index: 10000; animation: slideIn 0.5s ease-out;">
    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üèÜ</div>
    <div style="font-weight: 600;" id="achievementText">Achievement Unlocked!</div>
</div>

<script>
let currentGameMode = 'troubleshooting';

function selectGameMode(mode) {
    // Clear any existing intervals first
    clearInterval(timerInterval);
    timerInterval = null;
    
    currentGameMode = mode;
    
    // Reset all game states when switching modes
    score = 0;
    current = 0;
    correctStreak = 0;
    gameQuestions = [];
    timeLeft = 20;
    
    // Reset escape game state if switching away from it
    if (mode !== 'escape') {
        if (escapeGameState.timerInterval) {
            clearInterval(escapeGameState.timerInterval);
        }
        escapeGameState = {
            stage: 1,
            health: 100,
            distance: 0,
            questionsAnswered: 0,
            correctAnswers: 0,
            items: [],
            stageQuestionsAnswered: 0,
            currentTimeLeft: 0,
            timerInterval: null
        };
    }
    
    document.querySelectorAll('.mode-card').forEach(card => {
        card.style.border = '2px solid transparent';
        card.style.transform = 'scale(1)';
    });
    if (event && event.currentTarget) {
        event.currentTarget.style.border = '2px solid var(--secondary)';
        event.currentTarget.style.transform = 'scale(1.05)';
    }
    
    document.getElementById('gameArea').style.display = 'block';
    document.getElementById('gameModeSelection').style.display = 'none';
    document.getElementById('finalMessage').innerHTML = '';
    document.getElementById('progressBarContainer').style.display = 'none';
    document.getElementById('timer').innerText = '';
    document.getElementById("scorePanel").style.display = "none";
    
    const titles = {
        'troubleshooting': 'Network Troubleshooting Hero',
        'subnetting': 'Subnetting Challenge',
        'commands': 'Command Master',
        'protocols': 'Protocol Quiz',
        'escape': 'üå≤ Escape the Network Forest'
    };
    
    const descriptions = {
        'troubleshooting': 'Solve network problems under time pressure!',
        'subnetting': 'Calculate subnets quickly and accurately!',
        'commands': 'Match network commands with their functions!',
        'protocols': 'Test your knowledge of network protocols!',
        'escape': 'You\'re lost in a network forest! Answer questions correctly to find your way out!'
    };
    
    // Special start screen for escape game
    if (mode === 'escape') {
        const area = document.getElementById("gameArea");
        area.innerHTML = `
        <div class="game-card-header" style="background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 style="margin: 0; text-align: center; width: 100%;">üå≤ Escape the Network Forest</h3>
        </div>
            <div class="game-card-body" style="text-align: center;">
                <div style="font-size: 5rem; margin-bottom: 1.5rem;">üå≤üå≥üå≤</div>
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Welcome, Brave Explorer!</h3>
                <p style="margin-bottom: 1.5rem; color: #666; line-height: 1.8; font-size: 1.05rem;">
                    You find yourself lost in a mysterious Network Forest. The only way to escape is by proving your networking knowledge!<br><br>
                    Answer questions correctly to move forward, but be careful - wrong answers will cost you health!<br><br>
                    <strong>Can you make it through all ${escapeStages.length} stages and escape?</strong>
                </p>
                
                <div style="background: #e8f5e9; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 5px solid #4a7c2a;">
                    <h4 style="color: #2d5016; margin-bottom: 1rem;">üìã Game Rules:</h4>
                    <div style="text-align: left; display: inline-block;">
                        <p style="margin: 0.5rem 0;">‚úÖ Correct answers: Move forward + Gain XP</p>
                        <p style="margin: 0.5rem 0;">‚ùå Wrong answers: Lose health</p>
                        <p style="margin: 0.5rem 0;">‚ù§Ô∏è Health reaches 0: Game Over</p>
                        <p style="margin: 0.5rem 0;">üèÜ Complete all stages: Victory!</p>
                    </div>
                </div>
                
                <button class="btn" onclick="resetEscapeGame(); startEscapeGame();" style="background: linear-gradient(135deg, #4a7c2a 0%, #2d5016 100%); font-size: 1.2rem; padding: 1.2rem 2.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    üå≤ Begin Your Journey
                </button>
            </div>
        `;
    } else {
        // Regular game modes - show start screen
        const area = document.getElementById('gameArea');
        area.innerHTML = `
        <div class="game-card-header" style="position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 id="gameTitle" style="margin: 0; text-align: center; width: 100%;">${titles[mode]}</h3>
        </div>
        <div class="game-card-body">
            <p id="gameDescription">${descriptions[mode]}</p>
            <button class="btn" onclick="startGame()" id="startBtn">Start Game</button>
        </div>
        `;
    }
}

const scenarios = [
    { title:"DHCP Issue", description:"Users cannot get IP addresses (169.254.x.x). What is the first action?", options:["Restart PC","Check DHCP server","Change DNS","Check router"], answer:1, hint:"DHCP assigns IPs dynamically." },
    { title:"DNS Failure", description:"A user cannot access www.example.com but can ping 8.8.8.8. First step?", options:["Flush DNS cache","Check DNS server","Restart router","Change wallpaper"], answer:1, hint:"DNS resolves domain names to IPs." },
    { title:"ACL Problem", description:"Some traffic is unexpectedly blocked. What should you check?", options:["Ping localhost","Review ACL rules","Restart PC","Change DNS"], answer:1, hint:"ACL controls which traffic is allowed or denied." },
    { title:"Wireshark Analysis", description:"You see retransmissions in TCP flow. What does it indicate?", options:["Packet loss","Fast network","Normal traffic","Low latency"], answer:0, hint:"Retransmissions happen due to lost packets." },
    { title:"TCP Congestion Control", description:"During slow start, CWND increases how?", options:["Linearly","Exponentially","Randomly","Decreases"], answer:1, hint:"Slow start doubles CWND each RTT until threshold." },
    { title:"NAT Misconfiguration", description:"Users cannot access the internet behind NAT. First step?", options:["Verify NAT rules","Reboot router","Check DHCP","Disable firewall"], answer:0, hint:"NAT translates private IPs to public." },
    { title:"HTTP Issue", description:"Website images fail to load. Tool to investigate?", options:["Ping server","Check packet capture","Restart DHCP","Switch browser"], answer:1, hint:"Check if HTTP requests are reaching the server." },
    { title:"Network Congestion", description:"Network is slow between routers. First inspection?", options:["Check interface stats","Change IPs","Disable DNS","Flush cache"], answer:0, hint:"Interface stats show utilization and errors." },
    { title:"Firewall Block", description:"Service blocked unexpectedly. First check?", options:["Restart PC","Review firewall rules","Install printer","Disable DNS"], answer:1, hint:"Firewall rules define allowed services." },
    { title:"Final Challenge", description:"Packets dropping intermittently, multiple services fail. First action?", options:["Check logs & interface","Restart PC","Ping localhost","Change DNS server"], answer:0, hint:"Logs and interface counters give system state." }
];

// Subnetting Questions
const subnettingQuestions = [
    { question: "Network 192.168.1.0/24 needs 30 hosts per subnet. What is the subnet mask?", options: ["/27", "/26", "/28", "/25"], answer: 0, explanation: "/27 gives 30 usable hosts (32-2=30)" },
    { question: "How many subnets can you create from 192.168.1.0/24 by borrowing 3 bits?", options: ["6", "8", "4", "16"], answer: 1, explanation: "2¬≥ = 8 subnets" },
    { question: "What is the broadcast address for 192.168.1.32/27?", options: ["192.168.1.63", "192.168.1.64", "192.168.1.31", "192.168.1.95"], answer: 0, explanation: "Network: .32, Range: .33-.62, Broadcast: .63" },
    { question: "Network 10.0.0.0/8 needs 120 hosts per subnet. What CIDR notation?", options: ["/25", "/24", "/26", "/23"], answer: 0, explanation: "/25 gives 126 usable hosts (128-2=126)" },
    { question: "What is the increment for subnet 255.255.255.224?", options: ["32", "64", "16", "8"], answer: 0, explanation: "256 - 224 = 32" }
];

// Command Matching - Enhanced with more commands
const commandPairs = [
    { command: "ip route", description: "Configure static route", difficulty: "Easy" },
    { command: "show ip interface brief", description: "Display interface status", difficulty: "Easy" },
    { command: "vlan 10", description: "Create VLAN 10", difficulty: "Easy" },
    { command: "ip nat inside source", description: "Configure NAT translation", difficulty: "Medium" },
    { command: "access-list 1 permit", description: "Create ACL rule", difficulty: "Medium" },
    { command: "switchport mode trunk", description: "Configure trunk port", difficulty: "Medium" },
    { command: "encapsulation dot1q", description: "Configure VLAN encapsulation", difficulty: "Medium" },
    { command: "show ip nat translations", description: "View NAT table", difficulty: "Easy" },
    { command: "ip ospf cost", description: "Set OSPF interface cost", difficulty: "Hard" },
    { command: "router ospf 1", description: "Enter OSPF configuration mode", difficulty: "Hard" },
    { command: "network 192.168.1.0 0.0.0.255 area 0", description: "Advertise network in OSPF area 0", difficulty: "Hard" },
    { command: "ip address dhcp", description: "Obtain IP address via DHCP", difficulty: "Easy" },
    { command: "no shutdown", description: "Enable interface", difficulty: "Easy" },
    { command: "ip helper-address", description: "Forward DHCP requests", difficulty: "Hard" },
    { command: "spanning-tree portfast", description: "Enable PortFast on interface", difficulty: "Hard" },
    { command: "show ip route", description: "Display routing table", difficulty: "Easy" },
    { command: "show vlan brief", description: "Display VLAN information", difficulty: "Easy" },
    { command: "ip default-gateway", description: "Set default gateway for switch", difficulty: "Medium" },
    { command: "switchport access vlan", description: "Assign access port to VLAN", difficulty: "Medium" },
    { command: "ip access-group", description: "Apply ACL to interface", difficulty: "Hard" },
    { command: "show ip access-lists", description: "Display configured ACLs", difficulty: "Medium" },
    { command: "copy running-config startup-config", description: "Save configuration", difficulty: "Easy" },
    { command: "show cdp neighbors", description: "Display CDP neighbor information", difficulty: "Medium" },
    { command: "ip route 0.0.0.0 0.0.0.0", description: "Configure default route", difficulty: "Hard" }
];

// Protocol Questions
const protocolQuestions = [
    { question: "Which protocol is used for email transmission?", options: ["SMTP", "FTP", "HTTP", "DHCP"], answer: 0, hint: "Simple Mail Transfer Protocol" },
    { question: "What port does HTTPS use?", options: ["80", "443", "21", "25"], answer: 1, hint: "Secure HTTP uses port 443" },
    { question: "Which protocol provides reliable, connection-oriented communication?", options: ["UDP", "TCP", "ICMP", "ARP"], answer: 1, hint: "Transmission Control Protocol" },
    { question: "What does DNS stand for?", options: ["Domain Name System", "Dynamic Network Service", "Data Network System", "Domain Network Service"], answer: 0, hint: "Resolves domain names to IPs" },
    { question: "Which routing protocol uses link-state algorithm?", options: ["RIP", "OSPF", "BGP", "EIGRP"], answer: 1, hint: "Open Shortest Path First" }
];

let score=0, current=0, timerInterval=null, timeLeft=20, gameQuestions=[];
let xp=0, level=1, xpNeeded=100, streak=0, correctStreak=0;
let commandGameState = {
    round: 1,
    totalRounds: 3,
    currentMatches: {},
    timeLeft: 60,
    correctMatches: 0,
    totalMatches: 0,
    selectedPairs: [],
    difficulty: "Easy",
    totalScore: 0,
    totalCorrect: 0
};
let achievements = {
    firstWin: false,
    perfectGame: false,
    speedDemon: false,
    streakMaster: false,
    subnetExpert: false
};

function startGame(){
    // If escape game, don't use this function
    if (currentGameMode === 'escape') {
        return;
    }
    
    // Clear any existing intervals
    clearInterval(timerInterval);
    timerInterval = null;
    
    // Reset game state
    score = 0; 
    current = 0; 
    correctStreak = 0;
    timeLeft = currentGameMode === 'subnetting' ? 30 : 20;
    
    document.getElementById("score").innerText = score;
    document.getElementById("finalMessage").innerHTML = "";
    document.getElementById("progressBarContainer").style.display = "block";
    document.getElementById("timer").innerText = "";
    
    // Show score panel
    document.getElementById("scorePanel").style.display = "block";
    
    // Load saved progress
    loadGameProgress();
    updateLevelDisplay();
    
    // Load questions based on game mode
    if (currentGameMode === 'troubleshooting') {
        gameQuestions = [...scenarios];
    } else if (currentGameMode === 'subnetting') {
        gameQuestions = [...subnettingQuestions];
    } else if (currentGameMode === 'commands') {
        setupCommandGame();
        return;
    } else if (currentGameMode === 'protocols') {
        gameQuestions = [...protocolQuestions];
    }
    
    // Ensure we have questions
    if (!gameQuestions || gameQuestions.length === 0) {
        alert('Error loading questions. Please try selecting the game mode again.');
        backToModes();
        return;
    }
    
    loadQuestion(current);
    updateProgress();
}

function loadGameProgress() {
    const saved = localStorage.getItem('netlabpro_gameProgress');
    if (saved) {
        const progress = JSON.parse(saved);
        xp = progress.xp || 0;
        level = progress.level || 1;
        xpNeeded = progress.xpNeeded || 100;
        streak = progress.streak || 0;
    }
}

function saveGameProgress() {
    localStorage.setItem('netlabpro_gameProgress', JSON.stringify({
        xp, level, xpNeeded, streak
    }));
}

function updateLevelDisplay() {
    document.getElementById("level").innerText = level;
    document.getElementById("xp").innerText = xp;
    document.getElementById("xpNeeded").innerText = xpNeeded;
    const xpPercent = (xp / xpNeeded) * 100;
    document.getElementById("xpBar").style.width = xpPercent + '%';
}

function loadQuestion(n){
    // Don't load question if escape game is active
    if (currentGameMode === 'escape') {
        return;
    }
    
    clearInterval(timerInterval);
    timeLeft=currentGameMode === 'subnetting' ? 30 : 20;
    const q=gameQuestions[n];
    const area=document.getElementById("gameArea");
    
    const title = q.title || q.question || 'Question';
    const description = q.description || q.question || '';
    const hint = q.hint || q.explanation || '';
    
    area.innerHTML=`
        <div class="game-card-header" style="position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 style="margin: 0; text-align: center; width: 100%;">${title}</h3>
        </div>
        <div class="game-card-body">
            <p>${description}</p>
            ${hint ? `<span class="hint" onclick="alert('${hint}')">üí° Show Hint</span>` : ''}
            ${q.options.map((opt,i)=>`<button class="opt-btn" onclick="selectOption(${i})">${opt}</button>`).join('')}
        </div>
    `;
    document.getElementById("timer").innerText=`Time Left: ${timeLeft}s`;
    timerInterval=setInterval(()=>{
        timeLeft--;
        document.getElementById("timer").innerText=`Time Left: ${timeLeft}s`;
        if(timeLeft<=0){
            clearInterval(timerInterval);
            selectOption(-1);
        }
    },1000);
}

function setupCommandGame() {
    // Reset game state
    commandGameState = {
        round: 1,
        totalRounds: 3,
        currentMatches: {},
        timeLeft: 60,
        correctMatches: 0,
        totalMatches: 0,
        selectedPairs: [],
        difficulty: "Easy",
        totalScore: 0,
        totalCorrect: 0
    };
    
    // Show score panel
    document.getElementById("scorePanel").style.display = "block";
    document.getElementById("progressBarContainer").style.display = "block";
    document.getElementById("timer").innerText = "";
    
    startCommandRound();
}

function startCommandRound() {
    // Determine difficulty based on round
    const difficulties = ["Easy", "Medium", "Hard"];
    commandGameState.difficulty = difficulties[Math.min(commandGameState.round - 1, 2)];
    
    // Select commands based on difficulty
    let availableCommands = commandPairs.filter(c => {
        if (commandGameState.round === 1) return c.difficulty === "Easy";
        if (commandGameState.round === 2) return c.difficulty === "Easy" || c.difficulty === "Medium";
        return true; // Round 3: all difficulties
    });
    
    // Shuffle and select
    const shuffled = [...availableCommands].sort(() => Math.random() - 0.5);
    const numQuestions = commandGameState.round === 1 ? 5 : commandGameState.round === 2 ? 6 : 7;
    const selected = shuffled.slice(0, numQuestions);
    commandGameState.selectedPairs = selected;
    commandGameState.currentMatches = {};
    commandGameState.totalMatches = selected.length;
    commandGameState.timeLeft = commandGameState.round === 1 ? 60 : commandGameState.round === 2 ? 50 : 40;
    
    const area = document.getElementById("gameArea");
    area.innerHTML = `
        <div class="game-card-header" style="position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 style="margin: 0; text-align: center; width: 100%;">Command Master - Round ${commandGameState.round}/${commandGameState.totalRounds}</h3>
        </div>
        <div class="game-card-body">
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--secondary);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    <div>
                        <strong>‚è±Ô∏è Time:</strong> <span id="commandTimer" style="font-size: 1.2rem; font-weight: 700; color: var(--accent);">${commandGameState.timeLeft}s</span>
                    </div>
                    <div>
                        <strong>üìä Progress:</strong> <span id="commandProgress" style="font-weight: 700; color: var(--success);">0/${commandGameState.totalMatches}</span>
                    </div>
                    <div>
                        <strong>üéØ Difficulty:</strong> <span style="background: ${commandGameState.difficulty === 'Hard' ? '#e74c3c' : commandGameState.difficulty === 'Medium' ? '#f39c12' : '#2ecc71'}; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">${commandGameState.difficulty}</span>
                    </div>
                </div>
            </div>
            
            <p style="margin-bottom: 1rem; font-weight: 600; color: var(--primary);">Match each command with its correct description. Click a description button to match it with a command!</p>
            <div id="commandGameArea" style="margin-top: 1.5rem;"></div>
        </div>
    `;
    
    // Create command cards
    let html = '<div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">';
    selected.forEach((pair, idx) => {
        html += `
            <div style="display: flex; gap: 1rem; align-items: center; padding: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border: 2px solid #dee2e6; transition: all 0.3s;" id="command-row-${idx}" onmouseover="this.style.borderColor='var(--secondary)'; this.style.transform='translateX(3px)'" onmouseout="this.style.borderColor='#dee2e6'; this.style.transform='translateX(0)'">
                <div style="flex: 1; padding: 1rem; background: white; border-radius: 8px; border: 2px solid var(--secondary); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.3rem; font-weight: 600;">COMMAND</div>
                    <code style="font-size: 1.1rem; color: var(--primary); font-weight: 600;">${pair.command}</code>
                </div>
                <div style="font-size: 1.5rem; color: var(--secondary); font-weight: bold;">‚Üí</div>
                <div style="flex: 1; padding: 1rem; background: white; border-radius: 8px; border: 2px dashed #ddd; min-height: 60px; display: flex; align-items: center;" id="desc-${idx}">
                    <span id="desc-text-${idx}" style="color: #999; font-style: italic; width: 100%; text-align: center;">Click description below to match</span>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById("commandGameArea").innerHTML = html;
    
    // Shuffle descriptions and create buttons
    const descriptions = selected.map(p => p.description).sort(() => Math.random() - 0.5);
    const descContainer = document.createElement('div');
    descContainer.style.cssText = 'margin-top: 1.5rem; display: flex; flex-wrap: wrap; gap: 0.8rem; justify-content: center;';
    descContainer.innerHTML = '<div style="width: 100%; margin-bottom: 0.5rem; text-align: center; font-weight: 600; color: var(--primary);">üìã Available Descriptions (Click to Match):</div>';
    
    descriptions.forEach((desc, idx) => {
        const btn = document.createElement('button');
        btn.className = 'opt-btn';
        btn.textContent = desc;
        btn.style.cssText = 'margin: 0; padding: 0.8rem 1.2rem; font-size: 0.95rem; transition: all 0.3s;';
        btn.onclick = () => selectCommandDescription(desc);
        btn.onmouseover = function() { this.style.transform = 'scale(1.05)'; };
        btn.onmouseout = function() { this.style.transform = 'scale(1)'; };
        descContainer.appendChild(btn);
    });
    document.getElementById("commandGameArea").appendChild(descContainer);
    
    // Start timer
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        commandGameState.timeLeft--;
        const timerEl = document.getElementById("commandTimer");
        if (timerEl) {
            timerEl.textContent = commandGameState.timeLeft + "s";
            if (commandGameState.timeLeft <= 10) {
                timerEl.style.color = "#e74c3c";
                timerEl.style.animation = "pulse 0.5s infinite";
            }
        }
        if (commandGameState.timeLeft <= 0) {
            clearInterval(timerInterval);
            finishCommandRound();
        }
    }, 1000);
    
    updateCommandProgress();
}

function selectCommandDescription(desc) {
    // Find which command this matches
    const pairs = commandGameState.selectedPairs;
    const matchIdx = pairs.findIndex(p => p.description === desc);
    
    if (matchIdx >= 0 && !commandGameState.currentMatches[matchIdx]) {
        const pair = pairs[matchIdx];
        const isCorrect = pair.description === desc;
        
        commandGameState.currentMatches[matchIdx] = desc;
        
        // Update UI
        const descEl = document.getElementById(`desc-${matchIdx}`);
        const descTextEl = document.getElementById(`desc-text-${matchIdx}`);
        const rowEl = document.getElementById(`command-row-${matchIdx}`);
        
        if (isCorrect) {
            descEl.style.border = '2px solid var(--success)';
            descEl.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
            descTextEl.textContent = desc;
            descTextEl.style.color = 'var(--success)';
            descTextEl.style.fontStyle = 'normal';
            descTextEl.style.fontWeight = '600';
            rowEl.style.borderColor = 'var(--success)';
            commandGameState.correctMatches++;
            
            // Visual feedback
            showCommandFeedback("‚úÖ Correct!", "success");
            
            // Remove the description button
            const buttons = document.querySelectorAll('.opt-btn');
            buttons.forEach(btn => {
                if (btn.textContent === desc) {
                    btn.style.background = 'var(--success)';
                    btn.style.color = 'white';
                    btn.style.pointerEvents = 'none';
                    btn.style.opacity = '0.6';
                }
            });
        } else {
            descEl.style.border = '2px solid var(--accent)';
            descEl.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
            descTextEl.textContent = desc + " ‚ùå";
            descTextEl.style.color = 'var(--accent)';
            descTextEl.style.fontStyle = 'normal';
            rowEl.style.borderColor = 'var(--accent)';
            
            showCommandFeedback("‚ùå Wrong match! Try again.", "error");
            
            // Show correct answer after a delay
            setTimeout(() => {
                descEl.style.border = '2px solid var(--success)';
                descEl.style.background = 'linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%)';
                descTextEl.textContent = pair.description;
                descTextEl.style.color = 'var(--success)';
                rowEl.style.borderColor = 'var(--success)';
            }, 1500);
        }
        
        updateCommandProgress();
        
        // Check if all matched
        if (Object.keys(commandGameState.currentMatches).length === pairs.length) {
            clearInterval(timerInterval);
            setTimeout(() => {
                finishCommandRound();
            }, 2000);
        }
    }
}

function updateCommandProgress() {
    const progressEl = document.getElementById("commandProgress");
    if (progressEl) {
        const matched = Object.keys(commandGameState.currentMatches).length;
        progressEl.textContent = `${matched}/${commandGameState.totalMatches}`;
        progressEl.style.color = matched === commandGameState.totalMatches ? 'var(--success)' : 'var(--primary)';
    }
    
    // Update progress bar
    const percent = (Object.keys(commandGameState.currentMatches).length / commandGameState.totalMatches) * 100;
    document.getElementById("progressBar").style.width = percent + '%';
}

function finishCommandRound() {
    clearInterval(timerInterval);
    
    const pairs = commandGameState.selectedPairs;
    const totalCorrect = commandGameState.correctMatches;
    const accuracy = Math.round((totalCorrect / pairs.length) * 100);
    
    // Calculate score
    const baseScore = totalCorrect * 20;
    const timeBonus = Math.floor(commandGameState.timeLeft * 2);
    const roundBonus = commandGameState.round * 15;
    const roundScore = baseScore + timeBonus + roundBonus;
    
    commandGameState.totalScore += roundScore;
    commandGameState.totalCorrect += totalCorrect;
    score += roundScore;
    xp += roundScore;
    updateLevelDisplay();
    document.getElementById("score").innerText = score;
    
    // Check for level up
    while (xp >= xpNeeded) {
        xp -= xpNeeded;
        level++;
        xpNeeded = Math.floor(xpNeeded * 1.5);
        showAchievement(`Level Up! You reached Level ${level}! üéâ`);
    }
    
    if (commandGameState.round >= commandGameState.totalRounds) {
        // Game complete
        showCommandFinal();
    } else {
        // Next round
        commandGameState.round++;
        const area = document.getElementById("gameArea");
        area.innerHTML = `
            <div class="game-card-header" style="position: relative;">
                <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h3 style="margin: 0; text-align: center; width: 100%;">üéâ Round ${commandGameState.round - 1} Complete!</h3>
            </div>
            <div class="game-card-body" style="text-align: center;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">‚ú®</div>
                <h3 style="color: var(--primary); margin-bottom: 1rem;">Round ${commandGameState.round - 1} Results</h3>
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid var(--success);">
                    <p style="margin: 0.5rem 0;"><strong>‚úÖ Correct:</strong> ${totalCorrect}/${pairs.length}</p>
                    <p style="margin: 0.5rem 0;"><strong>üéØ Accuracy:</strong> ${accuracy}%</p>
                    <p style="margin: 0.5rem 0;"><strong>‚è±Ô∏è Time Remaining:</strong> ${commandGameState.timeLeft}s</p>
                    <p style="margin: 0.5rem 0;"><strong>‚≠ê Score:</strong> +${roundScore} (Base: ${baseScore} + Time: ${timeBonus} + Round: ${roundBonus})</p>
                </div>
                <button class="btn" onclick="startCommandRound()" style="background: var(--secondary); font-size: 1.1rem; padding: 1rem 2rem;">Continue to Round ${commandGameState.round} ‚Üí</button>
            </div>
        `;
    }
}

function showCommandFinal() {
    const totalAccuracy = Math.round((commandGameState.totalCorrect / (commandGameState.totalRounds * 5)) * 100);
    const totalScore = commandGameState.totalScore;
    const area = document.getElementById("gameArea");
    let rank = "Beginner";
    let emoji = "üå±";
    if (totalAccuracy >= 95) {
        rank = "Command Master";
        emoji = "üëë";
    } else if (totalAccuracy >= 85) {
        rank = "Command Expert";
        emoji = "‚≠ê";
    } else if (totalAccuracy >= 70) {
        rank = "Command Pro";
        emoji = "üåü";
    }
    
    area.innerHTML = `
        <div class="game-card-header" style="position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i> 
            </button>
            <h3 style="margin: 0; text-align: center; width: 100%;">üèÜ Game Complete!</h3>
        </div>
        <div class="game-card-body" style="text-align: center;">
            <div style="font-size: 5rem; margin-bottom: 1rem;">${emoji}</div>
            <h2 style="color: var(--primary); margin-bottom: 0.5rem;">Congratulations!</h2>
            <p style="margin-bottom: 1.5rem; color: #666;">You've completed all ${commandGameState.totalRounds} rounds!</p>
            
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe082 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid #f39c12;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">${emoji}</div>
                <h3 style="color: #e65100; margin-bottom: 1rem;">Rank: ${rank}</h3>
            </div>
            
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid var(--success);">
                <h4 style="color: var(--primary); margin-bottom: 1.5rem;">üìä Final Stats</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: left;">
                    <div>
                        <p style="margin: 0.8rem 0;"><strong>üéØ Overall Accuracy:</strong> <span style="color: #2e7d32; font-size: 1.2rem;">${totalAccuracy}%</span></p>
                        <p style="margin: 0.8rem 0;"><strong>‚≠ê Total Score:</strong> <span style="color: #f39c12; font-size: 1.2rem;">+${totalScore}</span></p>
                    </div>
                    <div>
                        <p style="margin: 0.8rem 0;"><strong>üìç Rounds Completed:</strong> <span style="color: #1565c0; font-size: 1.2rem;">${commandGameState.totalRounds}</span></p>
                        <p style="margin: 0.8rem 0;"><strong>‚úÖ Total Correct:</strong> <span style="color: #2e7d32; font-size: 1.2rem;">${commandGameState.totalCorrect}</span></p>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="setupCommandGame()" style="background: var(--success); font-size: 1.1rem; padding: 1rem 2rem;">üîÑ Play Again</button>
                <button class="btn" onclick="backToModes()" style="background: var(--primary); font-size: 1.1rem; padding: 1rem 2rem;">üè† Choose Another Game</button>
            </div>
        </div>
    `;
    
    document.getElementById("progressBarContainer").style.display = "none";
    document.getElementById("timer").innerText = "";
    saveGameProgress();
    showAchievement(`Command Master! üéØ You achieved ${totalAccuracy}% accuracy!`);
}

function showCommandFeedback(message, type) {
    const feedback = document.createElement('div');
    feedback.textContent = message;
    feedback.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${type === 'success' ? 'var(--success)' : 'var(--accent)'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        z-index: 10001;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: popInOut 1.5s ease-out;
    `;
    document.body.appendChild(feedback);
    setTimeout(() => feedback.remove(), 1500);
}

function selectOption(i){
    // Don't process if escape game is active
    if (currentGameMode === 'escape') {
        return;
    }
    
    clearInterval(timerInterval);
    const q=gameQuestions[current];
    const buttons=document.querySelectorAll(".opt-btn");
    
    let points = 10;
    let timeBonus = 0;
    let streakBonus = 0;
    
    // Time bonus
    if (timeLeft > 15) {
        points = 15;
        timeBonus = 5;
    } else if (timeLeft > 10) {
        points = 12;
        timeBonus = 2;
    }
    
    // Streak bonus
    if (correctStreak >= 3) {
        streakBonus = Math.floor(correctStreak / 3) * 2;
        points += streakBonus;
    }
    
    if(i===q.answer){ 
        correctStreak++;
        score+=points; 
        xp += points;
        
        // Check for level up
        while (xp >= xpNeeded) {
            xp -= xpNeeded;
            level++;
            xpNeeded = Math.floor(xpNeeded * 1.5);
            showAchievement(`Level Up! You reached Level ${level}! üéâ`);
        }
        
        document.getElementById("score").innerText=score; 
        updateLevelDisplay();
        
        if(i>=0) {
            buttons[i].classList.add('opt-correct');
            // Visual feedback
            showPointsFeedback(points, buttons[i]);
            
            // Check achievements
            checkAchievements(true, timeLeft);
            
            // Save progress
            const savedScore = parseInt(localStorage.getItem('netlabpro_score') || 0);
            localStorage.setItem('netlabpro_score', savedScore + points);
            saveGameProgress();
        }
    }
    else if(i>=0){ 
        correctStreak = 0; // Reset streak
        buttons[i].classList.add('opt-wrong'); 
        buttons[q.answer].classList.add('opt-correct');
        checkAchievements(false, 0);
    }

    setTimeout(()=>{
        current++;
        updateProgress();
        if(current<gameQuestions.length) loadQuestion(current);
        else showFinal();
    },1500);
}

function showPointsFeedback(points, element) {
    const feedback = document.createElement('div');
    feedback.textContent = `+${points} XP`;
    feedback.style.cssText = 'position: absolute; color: var(--success); font-weight: 700; font-size: 1.2rem; pointer-events: none; animation: floatUp 1s ease-out;';
    element.style.position = 'relative';
    element.appendChild(feedback);
    setTimeout(() => feedback.remove(), 1000);
}

function checkAchievements(correct, timeLeft) {
    // First Win
    if (!achievements.firstWin && score > 0) {
        achievements.firstWin = true;
        showAchievement('First Victory! üéØ');
    }
    
    // Speed Demon (answer in < 5 seconds)
    if (correct && timeLeft > 15 && !achievements.speedDemon) {
        achievements.speedDemon = true;
        showAchievement('Speed Demon! ‚ö°');
    }
    
    // Streak Master
    if (correctStreak >= 5 && !achievements.streakMaster) {
        achievements.streakMaster = true;
        showAchievement('Streak Master! üî•');
    }
}

function showAchievement(text) {
    const toast = document.getElementById('achievementToast');
    document.getElementById('achievementText').textContent = text;
    toast.style.display = 'block';
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

function showFinal(){
    // Don't show final for escape game - it has its own win/lose functions
    if (currentGameMode === 'escape') {
        return;
    }
    
    const area=document.getElementById("gameArea");
    area.innerHTML="";
    document.getElementById("timer").innerText="";
    const maxScore = gameQuestions.length * 15;
    const percentage = Math.round((score / maxScore) * 100);
    
    // Update streak
    if (percentage >= 80) {
        streak++;
        saveGameProgress();
    } else {
        streak = 0;
    }
    
    // Perfect game achievement
    if (percentage === 100 && !achievements.perfectGame) {
        achievements.perfectGame = true;
        showAchievement('Perfect Game! üèÜ');
    }
    
    let message = '';
    let emoji = 'üèÜ';
    let rank = 'Beginner';
    if (percentage === 100) {
        message = 'üéâ Perfect Score! You are a Network Master!';
        emoji = 'üëë';
        rank = 'Network Master';
    } else if (percentage >= 90) {
        message = 'üåü Outstanding! You are a Network Expert!';
        emoji = '‚≠ê';
        rank = 'Expert';
    } else if (percentage >= 80) {
        message = 'üåü Excellent Work! You know your networks!';
        emoji = '‚≠ê';
        rank = 'Advanced';
    } else if (percentage >= 60) {
        message = 'üëç Good Job! Keep practicing!';
        rank = 'Intermediate';
    } else {
        message = 'üí™ Keep Learning! Practice makes perfect!';
        rank = 'Beginner';
    }
    
    document.getElementById("finalMessage").innerHTML=`
        <div style="text-align: center; padding: 2rem; background: white; border-radius: 16px; box-shadow: var(--shadow-md);">
            <div style="font-size: 4rem; margin-bottom: 1rem;">${emoji}</div>
            <h3 style="color: var(--primary); margin-bottom: 1rem;">${message}</h3>
            <div style="background: var(--gradient-1); color: white; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Rank: ${rank}</div>
            </div>
            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">Your final score: <strong>${score}/${maxScore}</strong></p>
            <p style="color: #666; margin-bottom: 0.5rem;">Accuracy: <strong>${percentage}%</strong></p>
            <p style="color: #666; margin-bottom: 0.5rem;">Level: <strong>${level}</strong> | XP: <strong>${xp}/${xpNeeded}</strong></p>
            ${streak > 0 ? `<p style="color: var(--warning); font-weight: 600; margin-bottom: 1rem;">üî• Streak: ${streak} days!</p>` : ''}
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="startGame()">Play Again</button>
                <button class="btn" onclick="backToModes()" style="background: var(--primary);">Choose Another Game</button>
            </div>
        </div>
    `;
}

function backToModes() {
    // Clear any intervals
    clearInterval(timerInterval);
    timerInterval = null;
    
    // Hide game area and show mode selection
    document.getElementById('gameArea').style.display = 'none';
    document.getElementById('gameModeSelection').style.display = 'grid';
    document.getElementById('finalMessage').innerHTML = '';
    document.getElementById('progressBarContainer').style.display = 'none';
    document.getElementById('timer').innerText = '';
    
    // Hide score panel
    document.getElementById("scorePanel").style.display = "none";
    
    // Reset game states
    score = 0;
    current = 0;
    correctStreak = 0;
    gameQuestions = [];
    timeLeft = 20;
    document.getElementById("score").innerText = score;
    
    // Reset escape game state
    if (escapeGameState.timerInterval) {
        clearInterval(escapeGameState.timerInterval);
    }
    escapeGameState = {
        stage: 1,
        health: 100,
        distance: 0,
        questionsAnswered: 0,
        correctAnswers: 0,
        items: [],
        stageQuestionsAnswered: 0,
        currentTimeLeft: 0,
        timerInterval: null
    };
    
    // Reset command game state
    commandGameState = {
        round: 1,
        totalRounds: 3,
        currentMatches: {},
        timeLeft: 60,
        correctMatches: 0,
        totalMatches: 0,
        selectedPairs: [],
        difficulty: "Easy",
        totalScore: 0,
        totalCorrect: 0
    };
    
    // Reset current game mode
    currentGameMode = null;
    
    // Reset mode card selections
    document.querySelectorAll('.mode-card').forEach(card => {
        card.style.border = '2px solid transparent';
        card.style.transform = 'scale(1)';
    });
    
    // Reset game area to initial state
    const area = document.getElementById('gameArea');
    area.innerHTML = `
        <div class="game-card-header" style="position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 id="gameTitle" style="margin: 0; text-align: center; width: 100%;">Welcome Hero!</h3>
        </div>
        <div class="game-card-body">
            <p id="gameDescription">You are the network administrator. Solve network issues before time runs out!</p>
            <button class="btn" onclick="startGame()" id="startBtn">Start Mission</button>
        </div>
    `;
}

function updateProgress(){
    const percent = (current/gameQuestions.length)*100;
    document.getElementById("progressBar").style.width=`${percent}%`;
}
    
// ========== ESCAPE THE NETWORK FOREST GAME ==========
let escapeGameState = {
    stage: 1,
    health: 100,
    distance: 0,
    questionsAnswered: 0,
    correctAnswers: 0,
    currentObstacle: null,
    currentTimeLeft: 0,
    timerInterval: null
};

const escapeStages = [
    { name: "üå≤ Deep Forest", questions: 4, story: "You're lost deep in the network forest! The trees are dense and the path is unclear. Use your networking knowledge to navigate through!", icon: "üå≤", color: "#2d5016", timeLimit: 0, difficulty: "Easy" },
    { name: "üå≥ Dense Thicket", questions: 4, story: "The forest gets thicker! Vines block your way. Answer correctly to cut through the obstacles!", icon: "üå≥", color: "#1e3a0f", timeLimit: 0, difficulty: "Easy" },
    { name: "ü¶å River Crossing", questions: 3, story: "A wide river blocks your path! Build a bridge of knowledge by solving networking puzzles!", icon: "ü¶å", color: "#1e88e5", timeLimit: 0, difficulty: "Medium" },
    { name: "üèîÔ∏è Mountain Pass", questions: 3, story: "You've reached the mountains! The climb is steep. Your networking expertise will help you reach the summit!", icon: "üèîÔ∏è", color: "#5d4037", timeLimit: 25, difficulty: "Hard" },
    { name: "üåâ Bridge of Knowledge", questions: 2, story: "A mystical bridge appears! Answer these final questions to cross safely! ‚ö° TIME PRESSURE ACTIVATED!", icon: "üåâ", color: "#6a1b9a", timeLimit: 20, difficulty: "Very Hard" },
    { name: "üè† Safe Exit", questions: 2, story: "You can see the exit! One last challenge stands between you and freedom! ‚ö°‚ö° ULTIMATE CHALLENGE - EXTREME TIME PRESSURE!", icon: "üè†", color: "#f57c00", timeLimit: 15, difficulty: "Extreme" }
];

const escapeQuestions = [
    // Stage 1 - Deep Forest (4 questions)
    { question: "What does DHCP stand for?", options: ["Dynamic Host Configuration Protocol", "Data Host Control Protocol", "Domain Host Configuration Protocol", "Dynamic Host Control Process"], answer: 0, hint: "It automatically assigns IP addresses" },
    { question: "Which port does HTTP use?", options: ["80", "443", "21", "25"], answer: 0, hint: "Standard web browsing port" },
    { question: "What is the default subnet mask for Class C?", options: ["255.255.255.0", "255.255.0.0", "255.0.0.0", "192.168.1.0"], answer: 0, hint: "Class C uses 24 network bits" },
    { question: "What layer of OSI model does IP operate at?", options: ["Layer 2", "Layer 3", "Layer 4", "Layer 5"], answer: 1, hint: "Network layer" },
    
    // Stage 2 - Dense Thicket (4 questions)
    { question: "What does NAT do?", options: ["Translates private IPs to public", "Assigns IPs automatically", "Routes packets", "Encrypts data"], answer: 0, hint: "Network Address Translation" },
    { question: "Which protocol is connection-oriented?", options: ["UDP", "TCP", "ICMP", "ARP"], answer: 1, hint: "Reliable transmission protocol" },
    { question: "What is a VLAN?", options: ["Virtual Local Area Network", "Very Large Area Network", "Variable Local Area Network", "Virtual Link Area Network"], answer: 0, hint: "Logical grouping of devices" },
    { question: "What does MAC address stand for?", options: ["Media Access Control", "Multiple Access Control", "Main Access Control", "Media Access Code"], answer: 0, hint: "Physical address of network interface" },
    
    // Stage 3 - River Crossing (3 questions)
    { question: "What port does HTTPS use?", options: ["80", "443", "8080", "21"], answer: 1, hint: "Secure HTTP port" },
    { question: "What does DNS resolve?", options: ["Domain names to IPs", "IPs to MACs", "Ports to services", "Protocols to ports"], answer: 0, hint: "Domain Name System" },
    { question: "What is the purpose of ARP?", options: ["Resolve IP to MAC address", "Resolve domain to IP", "Route packets", "Encrypt data"], answer: 0, hint: "Address Resolution Protocol" },
    
    // Stage 4 - Mountain Pass (3 questions) - HARD
    { question: "In OSPF, what is the purpose of the DR (Designated Router)?", options: ["Reduce routing table size", "Reduce LSA flooding in multi-access networks", "Increase network speed", "Encrypt routing updates"], answer: 1, hint: "DR reduces OSPF traffic overhead" },
    { question: "What is the subnet mask for 192.168.1.0/26?", options: ["255.255.255.192", "255.255.255.128", "255.255.255.224", "255.255.255.0"], answer: 0, hint: "/26 = 26 network bits = 255.255.255.192" },
    { question: "Which routing protocol uses AS-path as a loop prevention mechanism?", options: ["OSPF", "RIP", "BGP", "EIGRP"], answer: 2, hint: "BGP uses AS-path attribute" },
    
    // Stage 5 - Bridge of Knowledge (2 questions) - VERY HARD with time pressure
    { question: "A network 172.16.0.0/16 needs 8 subnets with at least 2000 hosts each. What subnet mask should be used?", options: ["255.255.248.0 (/21)", "255.255.240.0 (/20)", "255.255.224.0 (/19)", "255.255.192.0 (/18)"], answer: 1, hint: "Need 2000+ hosts: /20 gives 4094 hosts per subnet" },
    { question: "In TCP congestion control, what happens when 3 duplicate ACKs are received?", options: ["Slow start begins", "Fast retransmit triggers", "Connection closes", "Window size doubles"], answer: 1, hint: "Fast retransmit on 3 duplicate ACKs" },
    
    // Stage 6 - Safe Exit (2 questions) - EXTREME difficulty
    { question: "What is the maximum number of usable IPs in a /22 network?", options: ["1022", "1024", "2046", "2048"], answer: 0, hint: "/22 = 10 host bits, 2^10 - 2 = 1022 usable" },
    { question: "In BGP, what is the purpose of the LOCAL_PREF attribute?", options: ["Prevent routing loops", "Prefer exit points within AS", "Set route origin", "Determine path length"], answer: 1, hint: "LOCAL_PREF influences outbound traffic path selection" }
];

function startEscapeGame() {
    // Show score panel
    document.getElementById("scorePanel").style.display = "block";
    
    // Initialize game state if starting fresh
    if (escapeGameState.stage === 0 || escapeGameState.questionsAnswered === 0) {
        if (escapeGameState.timerInterval) {
            clearInterval(escapeGameState.timerInterval);
        }
        escapeGameState = {
            stage: 1,
            health: 100,
            distance: 0,
            questionsAnswered: 0,
            correctAnswers: 0,
            items: [],
            stageQuestionsAnswered: 0,
            currentTimeLeft: 0,
            timerInterval: null
        };
    }
    
    const area = document.getElementById("gameArea");
    const currentStage = escapeStages[escapeGameState.stage - 1];
    const questionIndex = getQuestionIndexForStage();
    
    // Calculate progress percentage
    const totalQuestions = escapeStages.reduce((sum, stage) => sum + stage.questions, 0);
    const questionsDone = escapeGameState.correctAnswers + (escapeGameState.questionsAnswered - escapeGameState.correctAnswers);
    const progressPercent = Math.round((questionsDone / totalQuestions) * 100);
    
    area.innerHTML = `
        <div class="game-card-header" style="background: linear-gradient(135deg, ${currentStage.color} 0%, ${currentStage.color}dd 100%); position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 style="margin: 0; text-align: center; width: 100%;">${currentStage.icon} ${currentStage.name}</h3>
        </div>
        <div class="game-card-body">
            <!-- Story Box -->
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 1.2rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 5px solid ${currentStage.color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <p style="margin: 0; font-weight: 600; color: ${currentStage.color}; font-size: 1.05rem; line-height: 1.6;">${currentStage.story}</p>
            </div>
            
            <!-- Visual Progress Map -->
            <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: var(--primary);">üó∫Ô∏è Journey Progress</span>
                    <span style="font-weight: 600; color: ${currentStage.color};">${progressPercent}%</span>
                </div>
                <div style="display: flex; gap: 0.3rem; align-items: center; margin-bottom: 0.8rem;">
                    ${escapeStages.map((stage, idx) => `
                        <div style="flex: 1; text-align: center; position: relative;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.3rem;">${idx < escapeGameState.stage - 1 ? '‚úÖ' : idx === escapeGameState.stage - 1 ? 'üìç' : '‚≠ï'}</div>
                            <div style="font-size: 0.7rem; color: ${idx < escapeGameState.stage - 1 ? '#4caf50' : idx === escapeGameState.stage - 1 ? currentStage.color : '#999'}; font-weight: ${idx === escapeGameState.stage - 1 ? '600' : '400'};">
                                ${stage.icon}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="width: 100%; height: 8px; background: #ddd; border-radius: 10px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, #4caf50 0%, ${currentStage.color} 100%); width: ${progressPercent}%; transition: width 0.5s; border-radius: 10px;"></div>
                </div>
            </div>
            
            <!-- Stats Row -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; margin-bottom: 1.5rem;">
                <!-- Health -->
                <div style="background: #fff3e0; padding: 0.8rem; border-radius: 8px; text-align: center; border: 2px solid #ff9800;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">‚ù§Ô∏è</div>
                    <div style="font-weight: 700; color: #e65100; font-size: 1.2rem;" id="healthText">${escapeGameState.health}</div>
                    <div style="font-size: 0.75rem; color: #666; margin-top: 0.2rem;">Health</div>
                    <div style="width: 100%; height: 6px; background: #ffe0b2; border-radius: 3px; overflow: hidden; margin-top: 0.5rem;">
                        <div id="healthBar" style="height: 100%; background: linear-gradient(90deg, #ff6f00 0%, #e65100 100%); width: ${escapeGameState.health}%; transition: width 0.5s; border-radius: 3px;"></div>
                    </div>
                </div>
                
                <!-- Correct Answers -->
                <div style="background: #e8f5e9; padding: 0.8rem; border-radius: 8px; text-align: center; border: 2px solid #4caf50;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">‚úÖ</div>
                    <div style="font-weight: 700; color: #2e7d32; font-size: 1.2rem;">${escapeGameState.correctAnswers}</div>
                    <div style="font-size: 0.75rem; color: #666; margin-top: 0.2rem;">Correct</div>
                </div>
                
                <!-- Distance -->
                <div style="background: #e3f2fd; padding: 0.8rem; border-radius: 8px; text-align: center; border: 2px solid #2196f3;">
                    <div style="font-size: 1.8rem; margin-bottom: 0.3rem;">üìä</div>
                    <div style="font-weight: 700; color: #1565c0; font-size: 1.2rem;">${escapeGameState.distance}m</div>
                    <div style="font-size: 0.75rem; color: #666; margin-top: 0.2rem;">Distance</div>
                </div>
            </div>
            
            <!-- Stage Progress -->
            <div style="background: #f3e5f5; padding: 0.8rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; border: 2px solid #9c27b0;">
                <div style="font-weight: 600; color: #7b1fa2; margin-bottom: 0.3rem;">
                    üìç Stage ${escapeGameState.stage}/${escapeStages.length} - Question ${escapeGameState.stageQuestionsAnswered + 1}/${currentStage.questions}
                    ${currentStage.difficulty ? `<span style="background: ${currentStage.color}; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">${currentStage.difficulty}</span>` : ''}
                </div>
                <div style="width: 100%; height: 10px; background: #e1bee7; border-radius: 5px; overflow: hidden;">
                    <div style="height: 100%; background: linear-gradient(90deg, #ba68c8 0%, #9c27b0 100%); width: ${((escapeGameState.stageQuestionsAnswered) / currentStage.questions) * 100}%; transition: width 0.5s; border-radius: 5px;"></div>
                </div>
            </div>
            
            ${currentStage.timeLimit > 0 ? `
            <!-- Time Pressure Warning -->
            <div id="escapeTimerContainer" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center; border: 3px solid #c92a2a; box-shadow: 0 4px 15px rgba(255,107,107,0.4); animation: pulse 2s infinite;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö° TIME PRESSURE ACTIVATED ‚ö°</div>
                <div style="font-size: 2rem; font-weight: 700; color: white;" id="escapeTimer">${currentStage.timeLimit}s</div>
                <div style="font-size: 0.9rem; margin-top: 0.3rem; opacity: 0.9;">Answer quickly or lose extra health!</div>
            </div>
            ` : ''}
            
            <!-- Question Card -->
            <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 1.8rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid ${currentStage.color}40;">
                <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                    <div style="font-size: 2rem; margin-right: 0.8rem;">‚ùì</div>
                    <h4 style="color: var(--primary); margin: 0; font-size: 1.2rem; line-height: 1.4;">${escapeQuestions[questionIndex].question}</h4>
                </div>
                ${escapeQuestions[questionIndex].hint ? `
                    <div style="margin-bottom: 1rem;">
                        <span class="hint" onclick="showEscapeHint('${escapeQuestions[questionIndex].hint}')" style="cursor: pointer; background: ${currentStage.color}; color: white; padding: 0.5rem 1rem; border-radius: 6px; display: inline-block; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">üí° Need a hint?</span>
                    </div>
                ` : ''}
                <div style="display: grid; gap: 0.8rem;">
                    ${escapeQuestions[questionIndex].options.map((opt, i) => 
                        `<button class="opt-btn" onclick="answerEscapeQuestion(${i}, ${questionIndex})" style="margin: 0; padding: 1rem; text-align: left; font-size: 1rem; border: 2px solid ${currentStage.color}40; transition: all 0.3s;" onmouseover="this.style.borderColor='${currentStage.color}'; this.style.transform='translateX(5px)'" onmouseout="this.style.borderColor='${currentStage.color}40'; this.style.transform='translateX(0)'">${opt}</button>`
                    ).join('')}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById("progressBarContainer").style.display = "none";
    document.getElementById("timer").innerText = "";
    
    // Start timer if stage has time limit
    if (currentStage.timeLimit > 0) {
        escapeGameState.currentTimeLeft = currentStage.timeLimit;
        escapeGameState.timerInterval = setInterval(() => {
            escapeGameState.currentTimeLeft--;
            const timerEl = document.getElementById("escapeTimer");
            if (timerEl) {
                timerEl.textContent = escapeGameState.currentTimeLeft + "s";
                if (escapeGameState.currentTimeLeft <= 5) {
                    timerEl.parentElement.style.animation = "pulse 0.5s infinite";
                    timerEl.style.color = "#ffeb3b";
                }
                if (escapeGameState.currentTimeLeft <= 0) {
                    clearInterval(escapeGameState.timerInterval);
                    // Time's up - auto wrong answer
                    const buttons = document.querySelectorAll(".opt-btn");
                    if (buttons.length > 0) {
                        // Find wrong answer (not the correct one)
                        const question = escapeQuestions[questionIndex];
                        const wrongIndex = question.options.findIndex((opt, i) => i !== question.answer);
                        if (wrongIndex >= 0) {
                            answerEscapeQuestion(wrongIndex, questionIndex);
                        }
                    }
                }
            }
        }, 1000);
    }
}

function showEscapeHint(hint) {
    const hintBox = document.createElement('div');
    hintBox.innerHTML = `
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 10002; max-width: 400px; text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üí°</div>
            <h3 style="color: var(--primary); margin-bottom: 1rem;">Hint</h3>
            <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.6;">${hint}</p>
            <button onclick="this.parentElement.remove()" class="btn" style="background: var(--secondary);">Got it!</button>
        </div>
    `;
    document.body.appendChild(hintBox);
}

function getQuestionIndexForStage() {
    let index = 0;
    for (let i = 0; i < escapeGameState.stage - 1; i++) {
        index += escapeStages[i].questions;
    }
    return index + escapeGameState.stageQuestionsAnswered;
}

function answerEscapeQuestion(selectedIndex, questionIndex) {
    // Clear timer if exists
    if (escapeGameState.timerInterval) {
        clearInterval(escapeGameState.timerInterval);
        escapeGameState.timerInterval = null;
    }
    
    const question = escapeQuestions[questionIndex];
    const buttons = document.querySelectorAll(".opt-btn");
    const isCorrect = selectedIndex === question.answer;
    const currentStage = escapeStages[escapeGameState.stage - 1];
    
    // Disable all buttons
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.style.pointerEvents = 'none';
    });
    
    if (isCorrect) {
        // Correct answer - Success!
        buttons[selectedIndex].classList.add('opt-correct');
        escapeGameState.correctAnswers++;
        escapeGameState.distance += Math.floor(50 + (escapeGameState.stage * 10));
        escapeGameState.questionsAnswered++;
        escapeGameState.stageQuestionsAnswered++;
        
        // Bonus health for perfect answers
        if (escapeGameState.health < 100) {
            escapeGameState.health = Math.min(100, escapeGameState.health + 5);
        }
        
        // Add XP (more for later stages)
        const xpGain = 20 + (escapeGameState.stage * 5);
        xp += xpGain;
        score += xpGain;
        updateLevelDisplay();
        document.getElementById("score").innerText = score;
        
        // Show success animation
        showEscapeFeedback(`‚úÖ Correct! +${xpGain} XP | +${Math.floor(50 + (escapeGameState.stage * 10))}m`, "success");
        
        // Check if stage complete
        const currentStage = escapeStages[escapeGameState.stage - 1];
        if (escapeGameState.stageQuestionsAnswered >= currentStage.questions) {
            // Stage complete
            setTimeout(() => {
                completeEscapeStage();
            }, 2000);
        } else {
            // Next question in same stage
            setTimeout(() => {
                startEscapeGame();
            }, 2000);
        }
    } else {
        // Wrong answer - Take damage
        buttons[selectedIndex].classList.add('opt-wrong');
        buttons[question.answer].classList.add('opt-correct');
        
        // Extra damage if time ran out
        let damage = 15 + (escapeGameState.stage * 2); // More damage in later stages
        if (currentStage.timeLimit > 0 && escapeGameState.currentTimeLeft <= 0) {
            damage += 10; // Extra penalty for timeout
        }
        escapeGameState.health = Math.max(0, escapeGameState.health - damage);
        escapeGameState.questionsAnswered++;
        escapeGameState.stageQuestionsAnswered++;
        
        // Update health bar with animation
        setTimeout(() => {
            const healthBar = document.getElementById("healthBar");
            const healthText = document.getElementById("healthText");
            if (healthBar && healthText) {
                healthBar.style.width = escapeGameState.health + '%';
                healthText.textContent = escapeGameState.health;
                
                // Change color based on health
                if (escapeGameState.health < 30) {
                    healthBar.style.background = 'linear-gradient(90deg, #e74c3c 0%, #c0392b 100%)';
                } else if (escapeGameState.health < 60) {
                    healthBar.style.background = 'linear-gradient(90deg, #f39c12 0%, #e67e22 100%)';
                }
            }
        }, 100);
        
        if (escapeGameState.health <= 0) {
            // Game over
            setTimeout(() => {
                gameOverEscape();
            }, 2000);
        } else {
            showEscapeFeedback(`‚ùå Wrong! -${damage} Health!`, "error");
            
            const currentStage = escapeStages[escapeGameState.stage - 1];
            if (escapeGameState.stageQuestionsAnswered >= currentStage.questions) {
                setTimeout(() => {
                    completeEscapeStage();
                }, 2000);
            } else {
                setTimeout(() => {
                    startEscapeGame();
                }, 2000);
            }
        }
    }
}

function completeEscapeStage() {
    if (escapeGameState.stage >= escapeStages.length) {
        // Escaped!
        winEscapeGame();
        return;
    }
    
    const completedStage = escapeStages[escapeGameState.stage - 1];
    escapeGameState.stage++;
    escapeGameState.stageQuestionsAnswered = 0;
    
    // Stage completion bonus (more for difficult stages)
    const difficultyMultiplier = completedStage.difficulty === "Extreme" ? 2.5 : 
                                  completedStage.difficulty === "Very Hard" ? 2.0 :
                                  completedStage.difficulty === "Hard" ? 1.5 : 1.0;
    const stageBonus = Math.floor(escapeGameState.stage * 30 * difficultyMultiplier);
    xp += stageBonus;
    score += stageBonus;
    updateLevelDisplay();
    document.getElementById("score").innerText = score;
    
    const area = document.getElementById("gameArea");
    const currentStage = escapeStages[escapeGameState.stage - 1];
    
    // Calculate performance stats for completed stage
    // Use overall accuracy as stage-specific tracking would require more state management
    const overallAccuracy = escapeGameState.questionsAnswered > 0 ? 
        Math.round((escapeGameState.correctAnswers / escapeGameState.questionsAnswered) * 100) : 100;
    const stageAccuracy = overallAccuracy; // Show overall accuracy for now
    
    // Speed bonus (if timer was active and time remained)
    let speedBonus = 0;
    if (completedStage.timeLimit > 0 && escapeGameState.currentTimeLeft > 0) {
        speedBonus = Math.floor(escapeGameState.currentTimeLeft * 2);
        xp += speedBonus;
        score += speedBonus;
        updateLevelDisplay();
    }
    
    // Special effects for difficult stages
    const isDifficult = currentStage.difficulty === "Hard" || 
                       currentStage.difficulty === "Very Hard" || 
                       currentStage.difficulty === "Extreme";
    
    area.innerHTML = `
        <div class="game-card-header" style="background: linear-gradient(135deg, ${completedStage.color} 0%, ${completedStage.color}dd 100%); position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 style="margin: 0; text-align: center; width: 100%;">üéâ Stage Complete!</h3>
        </div>
        <div class="game-card-body" style="text-align: center;">
            <div style="font-size: 6rem; margin-bottom: 1rem; animation: bounce 1s ease-in-out infinite;">${completedStage.icon}</div>
            <h2 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.8rem;">${completedStage.icon} ${completedStage.name} Conquered!</h2>
            <p style="margin-bottom: 1.5rem; color: #666; font-size: 1.1rem;">You've successfully navigated through ${completedStage.name}!</p>
            
            ${stageAccuracy >= 100 ? `
            <div style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid #f39c12; box-shadow: 0 4px 15px rgba(255,215,0,0.4);">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üèÜ PERFECT STAGE! üèÜ</div>
                <div style="font-weight: 700; color: #e67e22;">100% Accuracy Bonus!</div>
            </div>
            ` : ''}
            
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid ${completedStage.color}; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h4 style="color: ${completedStage.color}; margin-bottom: 1rem; font-size: 1.2rem;">üèÜ Stage Rewards</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: left;">
                    <div>
                        <p style="margin: 0.5rem 0;"><strong>‚≠ê XP Bonus:</strong> <span style="color: #f39c12; font-size: 1.1rem;">+${stageBonus}</span></p>
                        <p style="margin: 0.5rem 0;"><strong>‚ù§Ô∏è Health:</strong> <span style="color: #e65100;">${escapeGameState.health}%</span></p>
                        ${speedBonus > 0 ? `<p style="margin: 0.5rem 0;"><strong>‚ö° Speed Bonus:</strong> <span style="color: #27ae60;">+${speedBonus} XP</span></p>` : ''}
                    </div>
                    <div>
                        <p style="margin: 0.5rem 0;"><strong>üìä Distance:</strong> <span style="color: #1565c0;">${escapeGameState.distance}m</span></p>
                        <p style="margin: 0.5rem 0;"><strong>‚úÖ Correct:</strong> <span style="color: #2e7d32;">${escapeGameState.correctAnswers}</span></p>
                        <p style="margin: 0.5rem 0;"><strong>üéØ Accuracy:</strong> <span style="color: #7b1fa2;">${stageAccuracy}%</span></p>
                    </div>
                </div>
            </div>
            
            ${isDifficult ? `
            <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid #c92a2a; box-shadow: 0 4px 15px rgba(255,107,107,0.4); animation: pulse 2s infinite;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö°‚ö° WARNING ‚ö°‚ö°</div>
                <h4 style="color: white; margin-bottom: 0.8rem; font-size: 1.3rem;">${currentStage.difficulty} CHALLENGE AHEAD!</h4>
                <p style="margin: 0; color: white; line-height: 1.6; font-size: 1.05rem;">
                    ${currentStage.story}<br><br>
                    <strong>‚ö†Ô∏è Time Limit: ${currentStage.timeLimit} seconds per question!</strong><br>
                    <strong>‚ö†Ô∏è Wrong answers deal ${15 + (escapeGameState.stage * 2) + 10} damage!</strong><br>
                    <strong>‚ö†Ô∏è Timeouts cause extra damage!</strong>
                </p>
            </div>
            ` : `
            <div style="background: #fff3e0; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 5px solid ${currentStage.color};">
                <h4 style="color: var(--primary); margin-bottom: 0.8rem;">üìç Next: ${currentStage.icon} ${currentStage.name}</h4>
                <p style="margin: 0; color: #666; line-height: 1.6;">${currentStage.story}</p>
                ${currentStage.difficulty ? `<p style="margin-top: 0.5rem; color: ${currentStage.color}; font-weight: 600;">Difficulty: ${currentStage.difficulty}</p>` : ''}
            </div>
            `}
            
            <button class="btn" onclick="startEscapeGame()" style="background: ${currentStage.color}; font-size: 1.1rem; padding: 1rem 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); ${isDifficult ? 'animation: pulse 2s infinite;' : ''}">
                ${isDifficult ? '‚ö° Accept Challenge ‚Üí' : 'Continue Journey ‚Üí'}
            </button>
        </div>
    `;
}

function winEscapeGame() {
    const area = document.getElementById("gameArea");
    const finalXP = escapeGameState.correctAnswers * 50 + (escapeStages.length * 100);
    xp += finalXP;
    score += finalXP;
    updateLevelDisplay();
    
    // Calculate accuracy
    const accuracy = Math.round((escapeGameState.correctAnswers / escapeGameState.questionsAnswered) * 100);
    
    // Save progress
    saveGameProgress();
    const savedScore = parseInt(localStorage.getItem('netlabpro_score') || 0);
    localStorage.setItem('netlabpro_score', savedScore + finalXP);
    
    // Determine rank based on performance
    let rank = "Beginner";
    let rankEmoji = "üå±";
    if (accuracy >= 95 && escapeGameState.health >= 80) {
        rank = "Network Master";
        rankEmoji = "üëë";
    } else if (accuracy >= 85) {
        rank = "Network Expert";
        rankEmoji = "‚≠ê";
    } else if (accuracy >= 70) {
        rank = "Network Explorer";
        rankEmoji = "üåü";
    }
    
    area.innerHTML = `
        <div class="game-card-header" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 style="margin: 0; text-align: center; width: 100%;">üèÜ VICTORY!</h3>
        </div>
        <div class="game-card-body" style="text-align: center;">
            <div style="font-size: 6rem; margin-bottom: 1rem; animation: bounce 1s ease-in-out infinite;">üéâ</div>
            <h2 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 2rem;">Congratulations, Network Explorer!</h2>
            <p style="margin-bottom: 1rem; color: #666; font-size: 1.2rem;">You successfully escaped the Network Forest!</p>
            
            <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe082 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid #f39c12; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${rankEmoji}</div>
                <h3 style="color: #e65100; margin-bottom: 1rem; font-size: 1.5rem;">Rank: ${rank}</h3>
            </div>
            
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid #4caf50; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h4 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 1.3rem;">üìä Your Journey Stats</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: left;">
                    <div>
                        <p style="margin: 0.8rem 0; font-size: 1.1rem;"><strong>‚úÖ Correct Answers:</strong> <span style="color: #2e7d32; font-size: 1.2rem;">${escapeGameState.correctAnswers}</span></p>
                        <p style="margin: 0.8rem 0; font-size: 1.1rem;"><strong>üìä Distance Traveled:</strong> <span style="color: #1565c0; font-size: 1.2rem;">${escapeGameState.distance}m</span></p>
                    </div>
                    <div>
                        <p style="margin: 0.8rem 0; font-size: 1.1rem;"><strong>üìç Stages Completed:</strong> <span style="color: #7b1fa2; font-size: 1.2rem;">${escapeStages.length}</span></p>
                        <p style="margin: 0.8rem 0; font-size: 1.1rem;"><strong>‚ù§Ô∏è Final Health:</strong> <span style="color: #e65100; font-size: 1.2rem;">${escapeGameState.health}%</span></p>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #4caf50;">
                    <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>üéØ Accuracy:</strong> <span style="color: #2e7d32; font-size: 1.3rem; font-weight: 700;">${accuracy}%</span></p>
                    <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>‚≠ê Total XP Earned:</strong> <span style="color: #f39c12; font-size: 1.3rem; font-weight: 700;">+${finalXP}</span></p>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="resetEscapeGame(); startEscapeGame();" style="background: var(--success); font-size: 1.1rem; padding: 1rem 2rem;">üîÑ Play Again</button>
                <button class="btn" onclick="backToModes()" style="background: var(--primary); font-size: 1.1rem; padding: 1rem 2rem;">üè† Choose Another Game</button>
            </div>
        </div>
    `;
    
    document.getElementById("score").innerText = score;
    showAchievement(`Forest Master! üå≤ You escaped with ${accuracy}% accuracy!`);
}

function resetEscapeGame() {
    // Clear any active timer
    if (escapeGameState.timerInterval) {
        clearInterval(escapeGameState.timerInterval);
    }
    
    escapeGameState = {
        stage: 1,
        health: 100,
        distance: 0,
        questionsAnswered: 0,
        correctAnswers: 0,
        items: [],
        stageQuestionsAnswered: 0,
        currentTimeLeft: 0,
        timerInterval: null
    };
}

function gameOverEscape() {
    const area = document.getElementById("gameArea");
    const accuracy = escapeGameState.questionsAnswered > 0 ? Math.round((escapeGameState.correctAnswers / escapeGameState.questionsAnswered) * 100) : 0;
    const xpEarned = escapeGameState.correctAnswers * 20;
    
    // Save partial progress
    if (xpEarned > 0) {
        xp += xpEarned;
        score += xpEarned;
        updateLevelDisplay();
        saveGameProgress();
        const savedScore = parseInt(localStorage.getItem('netlabpro_score') || 0);
        localStorage.setItem('netlabpro_score', savedScore + xpEarned);
    }
    
    area.innerHTML = `
        <div class="game-card-header" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); position: relative;">
            <button onclick="backToModes()" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s; z-index: 10;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h3 style="margin: 0; text-align: center; width: 100%;">üíÄ Game Over</h3>
        </div>
        <div class="game-card-body" style="text-align: center;">
            <div style="font-size: 5rem; margin-bottom: 1rem;">üò¢</div>
            <h2 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1.8rem;">You ran out of health!</h2>
            <p style="margin-bottom: 1.5rem; color: #666; font-size: 1.1rem;">The forest was too challenging this time. Don't give up! Review your networking concepts and try again.</p>
            
            <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 2rem; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid #e74c3c; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h4 style="color: var(--primary); margin-bottom: 1.5rem; font-size: 1.3rem;">üìä Your Progress</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: left;">
                    <div>
                        <p style="margin: 0.8rem 0; font-size: 1.1rem;"><strong>üìç Stages Reached:</strong> <span style="color: #7b1fa2; font-size: 1.2rem;">${escapeGameState.stage - 1}/${escapeStages.length}</span></p>
                        <p style="margin: 0.8rem 0; font-size: 1.1rem;"><strong>‚úÖ Correct Answers:</strong> <span style="color: #2e7d32; font-size: 1.2rem;">${escapeGameState.correctAnswers}</span></p>
                    </div>
                    <div>
                        <p style="margin: 0.8rem 0; font-size: 1.1rem;"><strong>üìä Distance:</strong> <span style="color: #1565c0; font-size: 1.2rem;">${escapeGameState.distance}m</span></p>
                        <p style="margin: 0.8rem 0; font-size: 1.1rem;"><strong>üéØ Accuracy:</strong> <span style="color: #e65100; font-size: 1.2rem;">${accuracy}%</span></p>
                    </div>
                </div>
                ${xpEarned > 0 ? `<div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e74c3c;">
                    <p style="margin: 0; font-size: 1.1rem;"><strong>‚≠ê XP Earned:</strong> <span style="color: #f39c12; font-size: 1.3rem; font-weight: 700;">+${xpEarned}</span></p>
                </div>` : ''}
            </div>
            
            <div style="background: #fff3e0; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 5px solid #f39c12;">
                <h4 style="color: var(--primary); margin-bottom: 0.8rem;">üí° Tips for Next Time:</h4>
                <div style="text-align: left; display: inline-block;">
                    <p style="margin: 0.5rem 0;">üìö Review the lab materials before playing</p>
                    <p style="margin: 0.5rem 0;">üí° Use hints when you're unsure</p>
                    <p style="margin: 0.5rem 0;">üéØ Focus on accuracy over speed</p>
                    <p style="margin: 0.5rem 0;">üîÑ Practice with flashcards first</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="resetEscapeGame(); startEscapeGame();" style="background: var(--accent); font-size: 1.1rem; padding: 1rem 2rem;">üîÑ Try Again</button>
                <button class="btn" onclick="backToModes()" style="background: var(--primary); font-size: 1.1rem; padding: 1rem 2rem;">üè† Choose Another Game</button>
            </div>
        </div>
    `;
    
    document.getElementById("score").innerText = score;
}

function showEscapeFeedback(message, type) {
    const feedback = document.createElement('div');
    feedback.innerHTML = `<div style="font-size: 2rem; margin-bottom: 0.5rem;">${type === 'success' ? '‚úÖ' : '‚ùå'}</div><div>${message}</div>`;
    feedback.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${type === 'success' ? 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)' : 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)'};
        color: white;
        padding: 1.5rem 2.5rem;
        border-radius: 16px;
        font-weight: 600;
        font-size: 1.2rem;
        z-index: 10001;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        animation: popInOut 2s ease-out;
        text-align: center;
        min-width: 250px;
    `;
    document.body.appendChild(feedback);
    setTimeout(() => {
        feedback.style.animation = 'fadeOut 0.5s ease-out';
        setTimeout(() => feedback.remove(), 500);
    }, 1500);
}
    
// Mobile Navigation Toggle
function toggleMobileNav() {
    const navLinks = document.getElementById('navLinks');
    const hamburger = document.getElementById('hamburger');
    navLinks.classList.toggle('active');
    const icon = hamburger.querySelector('i');
    if (navLinks.classList.contains('active')) {
        icon.classList.remove('fa-bars');
        icon.classList.add('fa-times');
    } else {
        icon.classList.remove('fa-times');
        icon.classList.add('fa-bars');
    }
}

// Close mobile nav when clicking outside
document.addEventListener('click', (e) => {
    const navLinks = document.getElementById('navLinks');
    const hamburger = document.getElementById('hamburger');
    if (navLinks && !navLinks.contains(e.target) && hamburger && !hamburger.contains(e.target)) {
        navLinks.classList.remove('active');
        if (hamburger) {
            const icon = hamburger.querySelector('i');
            if (icon) {
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        }
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGameProgress();
    updateLevelDisplay();
});

</script>

<!-- Cookie Consent -->
<div id="cookie-consent" class="cookie-consent" role="dialog" aria-live="polite" aria-label="Cookie consent">
    <div class="cookie-consent__content">
        <p>We use cookies to improve your experience and support ads. You can accept or decline. Read our <a href="privacy-policy.html" class="cookie-consent__link">Privacy Policy</a>.</p>
        <div class="cookie-consent__actions">
            <button type="button" class="cookie-btn secondary" data-consent="decline">Decline</button>
            <button type="button" class="cookie-btn primary" data-consent="accept">Accept</button>
        </div>
    </div>
</div>
<script>
(function () {
    var banner = document.getElementById('cookie-consent');
    if (!banner) {
        return;
    }
    var consent = localStorage.getItem('nlp_cookie_consent');
    if (!consent) {
        banner.style.display = 'block';
    }

    banner.addEventListener('click', function (event) {
        var target = event.target;
        if (!(target instanceof HTMLElement)) {
            return;
        }
        var choice = target.getAttribute('data-consent');
        if (!choice) {
            return;
        }
        localStorage.setItem('nlp_cookie_consent', choice);
        banner.style.display = 'none';
    });
})();
</script>
<script>
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/service-worker.js").catch(() => {});
        });
    }
</script>
</body>
</html>





